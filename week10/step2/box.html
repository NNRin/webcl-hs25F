<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>3D Scene</title>
    <link rel="stylesheet" href="../box/scene/scene.css">
    <script src="../box/scene/scene.js"></script>
    <style>
        html {
            overscroll-behavior:    none;
        }

        body {
            min-height:             100dvh;
            display:                grid;
            grid-template-columns:  100%;
            grid-template-rows:     1fr max-content;
            margin:                 0;
            background:             linear-gradient(in srgb-linear, blue, orange);
        }

        footer {
            padding:            1lh;
            display:            grid;
            place-items:        center;
            color:              white;
            font-size:          clamp(1rem, 5cqmin, 5rem);
        }
        .boxshadow {
            grid-area:          1/1;
            --box-width:        20;
            width:              calc(var(--box-width) * 1cqmin);
            aspect-ratio:       1 / 1;
            background-color:   #5d008b80;
            filter:             blur(3cqmin);
        }
        .shadowAnim {
            animation: shadowAnimation 2s ease-in-out;
        }
        @keyframes shadowAnimation {
              0% { scale: 1;   rotate: 0deg; }
             50% { scale: 1.3; rotate: 360deg; filter: blur(8cqmin);}
            100% { scale: 1;   rotate: 180deg; }

        }
        /* provides the logical group */
        .box {
            grid-area:          1/1;
            --box-width:        20;
            --z-center:         calc(1cqmin * var(--box-width) / 2);
            width:              calc(var(--box-width) * 1cqmin);
            aspect-ratio:       1 / 1;
            display:            grid;                              /* child positioning  */
            transform-style:    preserve-3d;                       /* put children in our 3d space */
            translate:          0 0 var(--z-center);
            --rotate-x:         0;
            --rotate-y:         0;
        }

        /* all children go directly on top of each other */
        .box > * {
            grid-area:          1/1;
        }


        /* the transform origin for rotate is center by default, so rotations must first */
        /* put the respective face in the the center, then rotate.            */

        .front  {transform:                 translateZ(var(--z-center));}  /* move front to center */
        .back   {transform: rotateY(180deg) translateZ(var(--z-center));}  /* center, then around Y-axis to the back */
        .left   {transform: rotateY(-90deg) translateZ(var(--z-center));}  /* center, then around Y-axis to the left */
        .right  {transform: rotateY( 90deg) translateZ(var(--z-center));}  /* center, then around Y-axis to the right */
        .top    {transform: rotateX( 90deg) translateZ(var(--z-center));}  /* center, then around X-axis to the top */
        .bottom {transform: rotateX(-90deg) translateZ(var(--z-center));}  /* center, then around X-axis to the bottom */

        .face {
            background-image:   linear-gradient(20deg in srgb-linear, #5d008bc0, 40%, darkgoldenrod, 60%, #5d008bc0);
            box-shadow:         0 0 2cqmin #5d008b inset;
            border-radius:      3%;
            display:            grid;
            place-items:        center;
            grid-template-columns: repeat(3, 1fr);
        }
        .circle {
            width: 1em;
            aspect-ratio: 1/1;
            background-color: black;
            border-radius: 50%;
        }



    </style>
</head>
<body>
<main id="main" class="scene3d noSelection">
    <div class="coords" style="
        --coords-rotate-x:  70;
        --coords-rotate-y: -25;
">
        <div class="boxshadow" id="boxshadow"></div>
        <div class="box" id="dice" >
             <div onclick="throwDice()" class="face front">
                <!-- Row 1 -->
                <div></div> <div></div> <div></div>
                 <!-- Row 2 -->
                <div></div> <div class="circle"></div> <div></div>
                 <!-- Row 3 -->
                <div></div> <div></div> <div></div>
             </div>
             <div onclick="throwDice()" class="face back" >
                 <!-- Row 1 -->
                 <div class="circle"></div> <div ></div><div class="circle"></div>
                 <!-- Row 2 -->
                 <div class="circle"></div> <div ></div><div class="circle"></div>
                 <!-- Row 3 -->
                 <div class="circle"></div> <div ></div><div class="circle"></div>
             </div>
             <div onclick="throwDice()" class="face left" >
                 <!-- Row 1 -->
                 <div></div> <div class="circle"></div> <div></div>
                 <!-- Row 2 -->
                 <div></div> <div></div> <div></div>
                 <!-- Row 3 -->
                 <div></div> <div class="circle"></div> <div></div>
             </div>
             <div onclick="throwDice()" class="face right">
                 <!-- Row 1 -->
                 <div class="circle"></div> <div></div> <div class="circle"></div>
                 <!-- Row 2 -->
                 <div></div> <div class="circle"></div> <div></div>
                 <!-- Row 3 -->
                 <div class="circle"></div> <div></div> <div class="circle"></div>
             </div>
             <div onclick="throwDice()" class="face top"  >
                 <!-- Row 1 -->
                 <div class="circle"></div> <div></div> <div></div>
                 <!-- Row 2 -->
                 <div></div> <div class="circle"></div> <div></div>
                 <!-- Row 3 -->
                 <div></div> <div></div> <div class="circle"></div>
             </div>
             <div onclick="throwDice()" class="face bottom">
                 <!-- Row 1 -->
                 <div class="circle"></div> <div></div> <div class="circle"></div>
                 <!-- Row 2 -->
                 <div></div> <div></div> <div></div>
                 <!-- Row 3 -->
                 <div class="circle"></div> <div></div> <div class="circle"></div>
             </div>
         </div>
    </div>
</main>
<footer>
    Click to throw dice. Use mouse or touch to rotate the coords.
</footer>

<script>
    /* value in Milliseconds defining for which duration the mouse must be pressed at most to be understood as a Click
     and not a drag */
    const CLICK_TO_DRAG_DELTA = 100;

    registerForMouseAndTouch(main);

    const randomSpinDegreeCalc = (min, max) => {
        return Math.floor(Math.random() * (max - min) + min);
    }

    const randomSpinningMotion = (min, max) =>{
        const rotation = randomSpinDegreeCalc(min, max);
        return Math.random() < 0.5 ? Number(-1 * rotation) : Number(rotation);
    }

    const throwDice = () => {

        console.log("Throwing Dice...");

        // get coordinate elements and current rotational params
        const coords = main.querySelector(".coords");
        const lastCoordsXRotate = window.getComputedStyle(coords, null).getPropertyValue('--coords-rotate-x');
        const lastCoordsYRotate = window.getComputedStyle(coords, null).getPropertyValue('--coords-rotate-y');

        // determine the random rotational values
        const xSpin = randomSpinningMotion(100, 500);
        const ySpin = randomSpinningMotion(100, 500);
        console.log("xSpin: " + xSpin);
        console.log("ySpin: " + ySpin);

        coords.style.setProperty('--coords-rotate-x', Number(lastCoordsXRotate) + xSpin);
        coords.style.setProperty('--coords-rotate-y', Number(lastCoordsYRotate) + ySpin);


    };

    // aync method to wait for user to release the mouse button
    const awaitRelease = (element) => {
        return new Promise(resolve => {
            element.addEventListener('mouseup', handler = () => {
                element.removeEventListener('mouseup', handler);
                resolve();
            });
        });
    }

    async function determineMouseDownEvent(e) {
        // measure time delta between mouse down and mouse up, by waiting for mouse to release
        const t0 = performance.now();
        await awaitRelease(main);
        const t1 = performance.now();
        const tDelta = t1 - t0;
        // a long delta indicates
        console.log("time diff: " + tDelta);

        if (tDelta < CLICK_TO_DRAG_DELTA) {
            throwDice();
        }
    };

     main.addEventListener('mousedown', determineMouseDownEvent);


</script>
</body>
</html>
